@using Microsoft.Extensions.Configuration
@inject IConfiguration configuration;
<li class="m-nav__item m-topbar__notifications m-topbar__notifications--img m-dropdown m-dropdown--large m-dropdown--header-bg-fill m-dropdown--arrow m-dropdown--align-center 	m-dropdown--mobile-full-width" data-dropdown-toggle="click" data-dropdown-persistent="true">
    <a href="#" class="m-nav__link m-dropdown__toggle" id="m_topbar_notification_icon">
        <span id="spDanger" class="m-nav__link-badge m-badge m-badge--dot m-badge--dot-small m-badge--danger"></span>
        <span id="spVibration" class="m-nav__link-icon">
            <i class="flaticon-music-2"></i>
        </span>
    </a>
    <div class="m-dropdown__wrapper">
        <span class="m-dropdown__arrow m-dropdown__arrow--center"></span>
        <div class="m-dropdown__inner">
            <div class="m-dropdown__header m--align-center" style="background: url('../css/default/media/img/misc/notification_bg.jpg'); background-size: cover;">
                <span id="countSayac" class="m-dropdown__header-title">
                    9 Yeni
                </span>
                <span class="m-dropdown__header-subtitle">
                    User Notifications
                </span>
            </div>
            <div class="m-dropdown__body">
                <div class="m-dropdown__content">
                    <ul class="nav nav-tabs m-tabs m-tabs-line m-tabs-line--brand" role="tablist">
                        <li class="nav-item m-tabs__item">
                            <a class="nav-link m-tabs__link active" data-toggle="tab" href="#topbar_notifications_notifications" role="tab">
                                DCP
                            </a>
                        </li>
                        @*<li class="nav-item m-tabs__item">
                                <a class="nav-link m-tabs__link" data-toggle="tab" href="#topbar_notifications_events" role="tab">
                                    Events
                                </a>
                            </li>*@
                        @*<li class="nav-item m-tabs__item">
                                <a class="nav-link m-tabs__link" data-toggle="tab" href="#topbar_notifications_logs" role="tab">
                                    Logs
                                </a>
                            </li>*@
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="topbar_notifications_notifications" role="tabpanel">
                            <div class="m-scrollable" data-scrollable="true" data-max-height="250" data-mobile-max-height="200">
                                <div class="m-list-timeline m-list-timeline--skin-light">
                                    <div class="m-list-timeline__items" id="DCPTextList">
                                        @*<div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge -m-list-timeline__badge--state-success"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    New order received
                                                </a>
                                                <span id="spnMesageDetay" class="m-list-timeline__time">
                                                    13 dk
                                                </span>
                                            </div>*@
                                    </div>
                                </div>
                            </div>
                        </div>
                        @*<div class="tab-pane" id="topbar_notifications_events" role="tabpanel">
                                <div class="m-scrollable" data-max-height="250" data-mobile-max-height="200">
                                    <div class="m-list-timeline m-list-timeline--skin-light">
                                        <div class="m-list-timeline__items">
                                            <div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge m-list-timeline__badge--state1-success"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    New order received
                                                </a>
                                                <span class="m-list-timeline__time">
                                                    Just now
                                                </span>
                                            </div>
                                            <div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge m-list-timeline__badge--state1-danger"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    New invoice received
                                                </a>
                                                <span class="m-list-timeline__time">
                                                    20 mins
                                                </span>
                                            </div>
                                            <div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge m-list-timeline__badge--state1-success"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    Production server up
                                                </a>
                                                <span class="m-list-timeline__time">
                                                    5 hrs
                                                </span>
                                            </div>
                                            <div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge m-list-timeline__badge--state1-info"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    New order received
                                                </a>
                                                <span class="m-list-timeline__time">
                                                    7 hrs
                                                </span>
                                            </div>
                                            <div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge m-list-timeline__badge--state1-info"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    System shutdown
                                                </a>
                                                <span class="m-list-timeline__time">
                                                    11 mins
                                                </span>
                                            </div>
                                            <div class="m-list-timeline__item">
                                                <span class="m-list-timeline__badge m-list-timeline__badge--state1-info"></span>
                                                <a href="" class="m-list-timeline__text">
                                                    Production server down
                                                </a>
                                                <span class="m-list-timeline__time">
                                                    3 hrs
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>*@
                        @*<div class="tab-pane" id="topbar_notifications_logs" role="tabpanel">
                                <div class="m-stack m-stack--ver m-stack--general" style="min-height: 180px;">
                                    <div class="m-stack__item m-stack__item--center m-stack__item--middle">
                                        <span class="">
                                            All caught up!
                                            <br>
                                            No new logs.
                                        </span>
                                    </div>
                                </div>
                            </div>*@
                    </div>
                </div>
            </div>
        </div>
    </div>
</li>





<script type="text/javascript" language="javascript">
    var myTime;
    var cityId;
    var id;
    $(document).ready(function () {
        cityId= "@configuration.GetSection("DBSettings")["CityId"]";
        ComingMessage();
    });
    function ComingMessage() {
            window.clearTimeout(this.myTime);
            $.ajax({
                url: "/Alarms/GetComingMessage",
                type: "GET",
                dataType: "json",
                success: function (res) {
                    $("#DCPTextList").empty();
                    if (res.length > 0) {
                        for (var i = 0; i < res.length; i++) {
                            var html = "<div id='" + res[i].Id + "' class=\"m-list-timeline__item\"><span class=\"m-list-timeline__badge m-list-timeline__badge--state1-info\"></span><a href='#' id='getmesaj" + res[i].Id + "' data-toggle='modal' data-target='#m_modal_4'  class=\"m-list-timeline__text\"></a><span id='spn" + res[i].Id + "' class=\"m-list-timeline__time\" ></span></div>";
                            $("#DCPTextList").append(html);
                           $('#getmesaj' + res[i].Id).text(res[i].GelenMesaj);
                            $('#spn' + res[i].Id).text(res[i].GecenSure + ' ' + res[i].ZamanTipi);
                            $("#countSayac").html(res.length);

                            $("#spDanger").attr("class", "m-nav__link-badge m-badge m-badge--dot m-badge--dot-small m-badge--danger m-animate-blink");
                            $("#spVibration").removeAttr("style", "animation: none !important;");
                            $("#spVibration").attr("class", "m-nav__link-icon m-animate-shake");

                        }
                        myTime = setTimeout(ComingMessage, 60000);
                    }
                    else {
                        $("#countSayac").html(0);
                        $("#spDanger").attr("class", "m-nav__link-badge");
                        $("#spVibration").attr("style", "animation: none !important;");
                        $("#spVibration").attr("class", "m-nav__link-icon");
                        myTime = setTimeout(ComingMessage, 60000);
                    }

                },
                error: function (xhr) {
                    $("#loading-image").hide();
                    command: toastr["error"]("Query Failed..!");
                }
            });
    }
    $("#DCPTextList").on('click', 'div', function () {
        id = this.id;
        var gelenMesaj =$("#" + id).children().text();
        gelenMesaj = gelenMesaj.split(':');
       var gelenMesajBaslik = gelenMesaj[0];
        var gelenMesajBody = $("#getmesaj" + id)[0].innerText; // gelenMesaj[1];
        $("#exampleModalLabel").html("<b>Gelen Mesaj :</b>" + ' ' + gelenMesajBaslik);
        $("#txtGelenMessage").html(gelenMesajBody);
    });

    function ReadMessage() {
        $.ajax({
           url: "/Alarms/ReadMessages/",
            data: { id: id},

            type: "POST",
            success: function() {
                toastr["success"]("Okuma işlemi Başarılı bir şekilde gerçekleştirildi!");
                $("#m_modal_4").modal('hide');
                ComingMessage();
            },
            error: function(xhr, ajaxOptions, thrownError) {
                toastr["warning"]("Okuma işlemi gerçekleştirilemedi!!");
                alert(xhr.status);
            }

        });
    }
</script>